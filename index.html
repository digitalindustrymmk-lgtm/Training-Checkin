<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ - Attendance</title>
    <link
      rel="icon"
      href="https://i.postimg.cc/gjD1VWD1/done.png"
      type="image/png·ûü"
    />
    
    <!-- Google Fonts: Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Kantumruy Pro', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6366F1', // Indigo 500
                        secondary: '#8B5CF6', // Violet 500
                        accent: '#F472B6', // Pink 400
                        background: '#F8FAFC',
                    },
                    animation: {
                        'float': 'float 10s ease-in-out infinite',
                        'float-fast': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'enter': 'enter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1)',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
                            '50%': { transform: 'translateY(-20px) rotate(5deg)' },
                        },
                        enter: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(40px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #F8FAFC;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }

        .gradient-text {
            background: linear-gradient(135deg, #4F46E5 0%, #EC4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #4F46E5 0%, #8B5CF6 100%);
        }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Icons ---
        const Icon = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Icons = {
            User: (p) => <Icon {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
            Search: (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
            Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
            LogOut: (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Icon>,
            Calendar: (p) => <Icon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>,
            FileText: (p) => <Icon {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
            X: (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>,
            Home: (p) => <Icon {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
            Send: (p) => <Icon {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>,
            Trash: (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>,
            Chart: (p) => <Icon {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></Icon>,
            Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>,
            ArrowRight: (p) => <Icon {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></Icon>,
            Sheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></Icon>,
        };

        // --- Config ---
        const sourceConfig = {
            apiKey: "AIzaSyCSCL7yNCMAuoqliqmDq24FrrfkvAxLBz4",
            authDomain: "itinfo-8501a.firebaseapp.com",
            databaseURL: "https://itinfo-8501a-default-rtdb.firebaseio.com",
            projectId: "itinfo-8501a",
            storageBucket: "itinfo-8501a.firebasestorage.app",
            messagingSenderId: "829674637790",
            appId: "1:829674637790:web:0ae1c4cd27b1e35a14f54f",
            measurementId: "G-VYXZXBHWFT"
        };

        const destConfig = {
            apiKey: "AIzaSyC3pJ5902riWQ_5tSNi2MxznKj3msUtXMg",
            authDomain: "att-e7aba.firebaseapp.com",
            databaseURL: "https://att-e7aba-default-rtdb.firebaseio.com",
            projectId: "att-e7aba",
            storageBucket: "att-e7aba.firebasestorage.app",
            messagingSenderId: "893825794222",
            appId: "1:893825794222:web:3e373a1801af855aecad3f",
            measurementId: "G-0SXDQ6SQMK"
        };

        const sourceApp = initializeApp(sourceConfig, "sourceApp");
        const destApp = initializeApp(destConfig, "destApp");
        const sourceDb = getDatabase(sourceApp);
        const destDb = getDatabase(destApp);

        // --- Components ---

        const EmployeeCard = React.memo(({ emp, record, index, onCheckIn }) => {
            const isCheckedIn = !!record;
            const isCheckedOut = record?.status === 'completed';
            const isPermissionIn = record?.checkInTime === "·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã";
            
            return (
                <div 
                    onClick={() => onCheckIn(emp)}
                    className="glass-panel p-4 mb-3 rounded-2xl flex items-center justify-between transition-all duration-300 hover:scale-[1.02] active:scale-95 cursor-pointer animate-slide-up"
                    style={{ animationDelay: `${index * 50}ms` }}
                >
                    <div className="flex items-center gap-4">
                        {/* Avatar */}
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold text-white shadow-md ${
                            isCheckedIn ? 'bg-gradient-to-br from-green-400 to-emerald-600' : 
                            'bg-gradient-to-br from-indigo-400 to-purple-600'
                        }`}>
                            {emp.khmer_name ? emp.khmer_name[0] : <Icons.User />}
                        </div>
                        
                        <div>
                            <div className="flex items-center gap-2">
                                <h3 className="font-bold text-slate-800 text-base">{emp.khmer_name}</h3>
                                {emp.telegram && (
                                    <a href={emp.telegram} target="_blank" onClick={(e) => e.stopPropagation()} className="bg-sky-100 p-2 rounded-full text-sky-500 hover:bg-sky-200 transition-colors shadow-sm">
                                        <Icons.Send size={16} className="-rotate-45 ml-0.5 mt-0.5" />
                                    </a>
                                )}
                            </div>
                            <div className="mt-1">
                                {isPermissionIn ? (
                                    <span className="text-[10px] font-bold text-orange-500 bg-orange-50 px-2 py-0.5 rounded-full border border-orange-100">
                                        ·ûÖ·üí·ûî·û∂·ûî·üã·ûÖ·ûº·ûõ
                                    </span>
                                ) : isCheckedIn ? (
                                    <span className="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100 flex items-center gap-1 w-fit">
                                        <Icons.Clock size={10} /> {record.checkInTime}
                                    </span>
                                ) : (
                                    <span className="text-[10px] font-medium text-slate-400">
                                        ·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûÖ·ûº·ûõ
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${
                        !isCheckedIn ? 'bg-indigo-50 text-indigo-600' :
                        !isCheckedOut ? 'bg-white border-2 border-red-100 text-red-500' : 
                        'bg-green-50 text-green-600'
                    }`}>
                        {!isCheckedIn ? <Icons.User size={20} /> : !isCheckedOut ? <Icons.LogOut size={20} /> : <Icons.Check size={20} />}
                    </div>
                </div>
            );
        });

        const ReportCard = React.memo(({ record, index, onDelete }) => {
            const isPermissionIn = record?.checkInTime === "·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã";
            const isPermissionOut = record?.checkOutTime === "·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã";
            const isCompleted = record.status === 'completed';

            return (
                <div 
                    className="bg-white p-4 mb-3 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden animate-slide-up"
                    style={{ animationDelay: `${index * 50}ms` }}
                >
                    <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${
                        (isPermissionIn || isPermissionOut) ? 'bg-orange-400' : isCompleted ? 'bg-slate-300' : 'bg-emerald-500'
                    }`}></div>

                    <div className="pl-3 flex justify-between items-start">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center font-bold text-slate-500 text-sm">
                                {record.khmer_name[0]}
                            </div>
                            <div>
                                <div className="flex items-center gap-2">
                                    <h4 className="font-bold text-slate-800 text-sm">{record.khmer_name}</h4>
                                    {record.telegram && (
                                        <a href={record.telegram} target="_blank" className="text-sky-500 bg-sky-50 p-1.5 rounded-full"><Icons.Send size={14} className="-rotate-45" /></a>
                                    )}
                                </div>
                                <span className={`text-[10px] font-bold ${
                                    (isPermissionIn || isPermissionOut) ? 'text-orange-500' : isCompleted ? 'text-slate-400' : 'text-emerald-600'
                                }`}>
                                    {(isPermissionIn || isPermissionOut) ? '‚Ä¢ ·ûÖ·üí·ûî·û∂·ûî·üã' : isCompleted ? '‚Ä¢ ·ûÖ·üÅ·ûâ·ûö·ûΩ·ûÖ' : '‚Ä¢ ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûí·üí·ûú·ûæ·ûÄ·û∂·ûö'}
                                </span>
                            </div>
                        </div>
                        <button onClick={() => onDelete(record.id, record.khmer_name)} className="text-slate-300 hover:text-red-500 p-2"><Icons.Trash size={16} /></button>
                    </div>

                    <div className="mt-3 pl-3 grid grid-cols-2 gap-4 text-sm relative">
                        <div className="absolute left-[50%] top-1 bottom-1 w-[1px] bg-slate-100 -translate-x-1/2"></div>
                        <div className="text-center">
                            <span className="text-[10px] text-slate-400 font-bold uppercase block mb-1">·ûò·üâ·üÑ·ûÑ·ûÖ·ûº·ûõ</span>
                            <span className={`inline-block px-2 py-0.5 rounded text-xs font-bold ${
                                isPermissionIn ? 'text-orange-600 bg-orange-50' : 'text-emerald-600 bg-emerald-50'
                            }`}>
                                {isPermissionIn ? '·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã' : record.checkInTime}
                            </span>
                        </div>
                        <div className="text-center">
                            <span className="text-[10px] text-slate-400 font-bold uppercase block mb-1">·ûò·üâ·üÑ·ûÑ·ûÖ·üÅ·ûâ</span>
                            <span className={`inline-block px-2 py-0.5 rounded text-xs font-bold ${
                                isPermissionOut ? 'text-orange-600 bg-orange-50' : 
                                record.checkOutTime ? 'text-slate-600 bg-slate-100' : 'text-slate-300'
                            }`}>
                                {isPermissionOut ? '·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã' : (record.checkOutTime || '--:--')}
                            </span>
                        </div>
                    </div>
                    
                    {(record.checkInReason || record.checkOutReason) && (
                        <div className="mt-3 pt-2 border-t border-slate-50 pl-3">
                            <p className="text-[10px] text-slate-500 italic bg-slate-50 p-2 rounded-lg">
                                {record.checkInReason && <span><span className="text-orange-500 font-bold">·ûÖ·ûº·ûõ:</span> {record.checkInReason} </span>}
                                {record.checkOutReason && <span><span className="text-orange-500 font-bold">·ûÖ·üÅ·ûâ:</span> {record.checkOutReason}</span>}
                            </p>
                        </div>
                    )}
                </div>
            );
        });

        const Skeleton = () => (
            <div className="glass-panel p-4 rounded-2xl mb-3 flex items-center gap-4 animate-pulse">
                <div className="w-12 h-12 rounded-full bg-slate-200"></div>
                <div className="flex-1 space-y-2">
                    <div className="h-4 w-32 bg-slate-200 rounded"></div>
                    <div className="h-3 w-20 bg-slate-200 rounded"></div>
                </div>
            </div>
        );

        function App() {
            const [activeTab, setActiveTab] = useState('attendance');
            const [employees, setEmployees] = useState([]);
            const [todayAttendance, setTodayAttendance] = useState({});
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [notification, setNotification] = useState(null);
            
            // Modal States
            const [selectedEmp, setSelectedEmp] = useState(null);
            const [showActionModal, setShowActionModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [permissionReason, setPermissionReason] = useState('');
            const [isPermissionMode, setIsPermissionMode] = useState(false);
            
            const todayKey = new Date().toISOString().split('T')[0];

            useEffect(() => {
                const usersRef = ref(sourceDb, 'users');
                const unsubscribe = onValue(usersRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const loaded = Object.keys(data).map(key => ({
                            id: key, 
                            khmer_name: data[key].khmer_name || data[key].first_name || "·ûÇ·üí·ûò·û∂·ûì·ûà·üí·ûò·üÑ·üá",
                            telegram: data[key].link || ""
                        }));
                        setEmployees(loaded.sort((a, b) => a.khmer_name.localeCompare(b.khmer_name)));
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const attendanceRef = ref(destDb, `attendance/${todayKey}`);
                const unsubscribe = onValue(attendanceRef, (snapshot) => {
                    setTodayAttendance(snapshot.val() || {});
                });
                return () => unsubscribe();
            }, [todayKey]);

            const showNotification = useCallback((message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            }, []);

            const openActionModal = useCallback((emp) => {
                setSelectedEmp(emp);
                setIsPermissionMode(false);
                setPermissionReason('');
                setShowActionModal(true);
            }, []);

            const closeAllModals = () => {
                setShowActionModal(false);
                setSelectedEmp(null);
                setDeleteTarget(null);
                setIsPermissionMode(false);
                setPermissionReason('');
            };

            const handleCheckIn = async () => {
                if (!selectedEmp) return;
                const now = new Date();
                const timeString = now.toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit' });
                try {
                    await set(ref(destDb, `attendance/${todayKey}/${selectedEmp.id}`), {
                        khmer_name: selectedEmp.khmer_name,
                        checkInTime: timeString,
                        checkInTimestamp: now.toISOString(),
                        status: 'present',
                        type: 'work',
                        checkOutTime: null
                    });
                    showNotification(`‚úÖ ·ûî·û∂·ûì·ûÖ·ûº·ûõ: ${selectedEmp.khmer_name}`);
                    closeAllModals();
                } catch (error) { console.error(error); }
            };

            // Direct Check Out
            const performCheckOut = async () => {
                if (!selectedEmp) return;
                const now = new Date();
                const timeString = now.toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit' });
                try {
                    await update(ref(destDb, `attendance/${todayKey}/${selectedEmp.id}`), {
                        checkOutTime: timeString,
                        checkOutTimestamp: now.toISOString(),
                        status: 'completed'
                    });
                    showNotification(`üëã ·ûî·û∂·ûì·ûÖ·üÅ·ûâ: ${selectedEmp.khmer_name}`);
                    closeAllModals();
                } catch (error) { console.error(error); }
            };

            const handlePermission = async () => {
                if (!selectedEmp || !permissionReason.trim()) return;
                const now = new Date();
                const isAlreadyCheckedIn = todayAttendance[selectedEmp.id];

                try {
                    if (isAlreadyCheckedIn) {
                        await update(ref(destDb, `attendance/${todayKey}/${selectedEmp.id}`), {
                            checkOutTime: "·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã",
                            checkOutTimestamp: now.toISOString(),
                            checkOutReason: permissionReason,
                            status: 'completed'
                        });
                        showNotification(`üìù ·ûÖ·üí·ûî·û∂·ûî·üã·ûÖ·üÅ·ûâ: ${selectedEmp.khmer_name}`);
                    } else {
                        await set(ref(destDb, `attendance/${todayKey}/${selectedEmp.id}`), {
                            khmer_name: selectedEmp.khmer_name,
                            checkInTime: "·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã",
                            checkInTimestamp: now.toISOString(),
                            checkInReason: permissionReason,
                            status: 'present',
                            type: 'permission',
                            checkOutTime: null
                        });
                        showNotification(`üìù ·ûÖ·üí·ûî·û∂·ûî·üã·ûÖ·ûº·ûõ: ${selectedEmp.khmer_name}`);
                    }
                    closeAllModals();
                } catch (error) { console.error(error); }
            };

            const deleteRecord = async () => {
                if (!deleteTarget) return;
                try {
                    await remove(ref(destDb, `attendance/${todayKey}/${deleteTarget.id}`));
                    showNotification(`üóëÔ∏è ·ûî·û∂·ûì·ûõ·ûª·ûî: ${deleteTarget.name}`);
                    closeAllModals();
                } catch (e) { console.error(e); }
            };

            const exportToExcel = () => {
                const data = employees.map(emp => ({
                    'ID': emp.id,
                    '·ûà·üí·ûò·üÑ·üá': emp.khmer_name,
                    'Telegram': emp.telegram || '-'
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "·ûî·ûâ·üí·ûá·û∏·ûà·üí·ûò·üÑ·üá·ûî·ûª·ûÇ·üí·ûÇ·ûõ·û∑·ûÄ");
                
                // Save the Excel file
                XLSX.writeFile(wb, `Employee_List_${todayKey}.xlsx`);
                showNotification("üì• ·ûî·û∂·ûì·ûë·û∂·ûâ·ûô·ûÄ·ûî·ûâ·üí·ûá·û∏·ûà·üí·ûò·üÑ·üá");
            };

            const filtered = useMemo(() => employees.filter(e => 
                e.khmer_name?.toLowerCase().includes(searchTerm.toLowerCase())
            ), [employees, searchTerm]);

            const reportList = useMemo(() => Object.keys(todayAttendance).map(key => {
                const emp = employees.find(e => e.id === key);
                return { id: key, ...todayAttendance[key], telegram: emp?.telegram };
            }).sort((a, b) => (a.checkInTimestamp || '').localeCompare(b.checkInTimestamp || '')), [todayAttendance, employees]);

            const isAlreadyCheckedIn = selectedEmp && todayAttendance[selectedEmp.id];

            return (
                <div className="min-h-screen pb-32 font-sans text-slate-800">
                    
                    {/* Animated Background */}
                    <div className="fixed inset-0 z-[-1] overflow-hidden">
                        <div className="absolute top-[-10%] left-[-10%] w-[300px] h-[300px] bg-purple-200 rounded-full blur-[100px] opacity-50 animate-float"></div>
                        <div className="absolute top-[20%] right-[-10%] w-[200px] h-[200px] bg-blue-200 rounded-full blur-[80px] opacity-50 animate-float-fast"></div>
                        <div className="absolute bottom-[-10%] left-[20%] w-[250px] h-[250px] bg-pink-100 rounded-full blur-[90px] opacity-60 animate-pulse-slow"></div>
                    </div>

                    {/* Header */}
                    <div className="sticky top-0 z-40 glass-nav px-5 py-4 flex justify-between items-center transition-all duration-300">
                        <div>
                            <h1 className="text-xl font-black gradient-text tracking-tight">·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí·ûú·ûè·üí·ûè·ûò·û∂·ûì</h1>
                            <p className="text-[10px] font-bold text-slate-400 mt-0.5 uppercase tracking-wide">
                                {new Date().toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'short' })}
                            </p>
                        </div>
                        <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-lg shadow-indigo-100/50 text-indigo-600 border border-slate-50">
                            <Icons.Calendar size={20} />
                        </div>
                    </div>

                    <div className="px-4 pt-6">
                        
                        {/* Notification */}
                        {notification && (
                            <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[60] glass-panel px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-enter min-w-[280px]">
                                <span className={`text-lg ${notification.type === 'error' ? 'text-red-500' : 'text-emerald-500'}`}>
                                    {notification.type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}
                                </span>
                                <span className="font-bold text-sm text-slate-700">{notification.message}</span>
                            </div>
                        )}

                        {activeTab === 'attendance' && (
                            <div className="animate-enter">
                                {/* Search */}
                                <div className="relative mb-6">
                                    <div className="absolute inset-0 bg-indigo-500/10 blur-xl rounded-full"></div>
                                    <div className="relative bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center p-1.5 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                                        <Icons.Search className="ml-3 text-slate-400" size={20} />
                                        <input 
                                            className="w-full pl-3 pr-4 py-2.5 bg-transparent outline-none font-bold text-slate-700 placeholder-slate-400"
                                            placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ..."
                                            value={searchTerm}
                                            onChange={e => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                </div>

                                <div className="flex justify-between items-center px-2 mb-4">
                                    <h2 className="font-bold text-lg text-slate-700">·ûî·ûâ·üí·ûá·û∏·ûà·üí·ûò·üÑ·üá</h2>
                                    
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={exportToExcel}
                                            className="bg-emerald-500 text-white p-2 rounded-lg shadow-md active:scale-95 transition-all flex items-center gap-1.5"
                                            title="·ûë·û∂·ûâ·ûô·ûÄ·ûî·ûâ·üí·ûá·û∏·ûà·üí·ûò·üÑ·üá"
                                        >
                                            <Icons.Sheet size={16} />
                                            <span className="text-xs font-bold">Excel</span>
                                        </button>
                                        <span className="text-[10px] font-bold bg-white px-3 py-1.5 rounded-full text-slate-400 border border-slate-100 shadow-sm h-fit">
                                            TOTAL: {filtered.length}
                                        </span>
                                    </div>
                                </div>

                                {loading ? [1,2,3,4].map(i => <Skeleton key={i} />) : (
                                    <div className="space-y-1">
                                        {filtered.map((emp, idx) => (
                                            <EmployeeCard 
                                                key={emp.id} 
                                                emp={emp} 
                                                record={todayAttendance[emp.id]} 
                                                index={idx}
                                                onCheckIn={openActionModal}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'report' && (
                            <div className="animate-enter">
                                {/* Summary Card */}
                                <div className="gradient-bg rounded-[32px] p-6 text-white shadow-xl shadow-indigo-500/30 mb-6 relative overflow-hidden">
                                    <div className="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                                    <div className="absolute -left-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                                    
                                    <div className="relative z-10">
                                        <div className="flex justify-between items-start mb-6">
                                            <div>
                                                <h2 className="font-bold text-xl">·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç</h2>
                                                <p className="text-indigo-100 text-xs mt-1 opacity-80">·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá</p>
                                            </div>
                                            <div className="bg-white/20 backdrop-blur px-3 py-1 rounded-lg text-xs font-bold border border-white/10">
                                                {reportList.length} ·ûì·û∂·ûÄ·üã
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div className="bg-white/10 backdrop-blur rounded-2xl p-2.5 text-center border border-white/10">
                                                <span className="block text-xl font-black">{Object.values(todayAttendance).filter(r => r.status === 'present' || r.status === 'completed').length}</span>
                                                <span className="text-[9px] opacity-70 uppercase font-bold">·ûú·ûè·üí·ûè·ûò·û∂·ûì</span>
                                            </div>
                                            <div className="bg-white/10 backdrop-blur rounded-2xl p-2.5 text-center border border-white/10">
                                                <span className="block text-xl font-black text-orange-200">{Object.values(todayAttendance).filter(r => r.checkInTime === "·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã" || r.checkOutTime === "·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã").length}</span>
                                                <span className="text-[9px] opacity-70 uppercase font-bold">·ûÖ·üí·ûî·û∂·ûî·üã</span>
                                            </div>
                                            <div className="bg-white/10 backdrop-blur rounded-2xl p-2.5 text-center border border-white/10">
                                                <span className="block text-xl font-black text-red-200">{employees.length - Object.values(todayAttendance).length}</span>
                                                <span className="text-[9px] opacity-70 uppercase font-bold">·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-1">
                                    {reportList.map((record, idx) => (
                                        <ReportCard 
                                            key={record.id} 
                                            record={record} 
                                            index={idx}
                                            onDelete={(id, name) => setDeleteTarget({id, name})}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Floating Bottom Nav */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-auto z-40">
                        <div className="glass-nav rounded-full p-1.5 flex shadow-2xl gap-1">
                            <button 
                                onClick={() => setActiveTab('attendance')}
                                className={`px-6 py-3 rounded-full flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'attendance' ? 'bg-slate-900 text-white shadow-lg' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Home size={18} />
                                {activeTab === 'attendance' && <span className="text-xs font-bold animate-enter">·ûú·ûè·üí·ûè·ûò·û∂·ûì</span>}
                            </button>
                            <button 
                                onClick={() => setActiveTab('report')}
                                className={`px-6 py-3 rounded-full flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'report' ? 'bg-slate-900 text-white shadow-lg' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Chart size={18} />
                                {activeTab === 'report' && <span className="text-xs font-bold animate-enter">·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç</span>}
                            </button>
                        </div>
                    </div>

                    {/* Modals */}
                    {(showActionModal || deleteTarget) && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-enter" onClick={closeAllModals}></div>
                            
                            {/* Action Modal */}
                            {showActionModal && selectedEmp && (
                                <div className="bg-white w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl relative z-10 animate-enter transform transition-all">
                                    <div className="p-6 pb-4 flex justify-between items-start bg-slate-50 border-b border-slate-100">
                                        <div className="flex gap-4 items-center">
                                            <div className="w-14 h-14 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl shadow-lg">
                                                {selectedEmp.khmer_name[0]}
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-lg text-slate-800">{selectedEmp.khmer_name}</h3>
                                                <p className="text-xs text-slate-500 font-medium">·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ</p>
                                            </div>
                                        </div>
                                        <button onClick={closeAllModals} className="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm text-slate-400 hover:text-slate-600"><Icons.X size={18}/></button>
                                    </div>
                                    
                                    <div className="p-6">
                                        {!isPermissionMode ? (
                                            <div className="grid grid-cols-2 gap-4">
                                                <button 
                                                    onClick={isAlreadyCheckedIn ? performCheckOut : handleCheckIn}
                                                    className={`flex flex-col items-center gap-3 p-5 rounded-3xl transition-transform active:scale-95 ${
                                                        isAlreadyCheckedIn ? 'bg-red-50 text-red-500 border-2 border-red-100' : 'gradient-bg text-white shadow-lg shadow-indigo-300'
                                                    }`}
                                                >
                                                    <div className={`p-3 rounded-full ${isAlreadyCheckedIn ? 'bg-red-100' : 'bg-white/20'}`}>
                                                        {isAlreadyCheckedIn ? <Icons.LogOut size={28}/> : <Icons.Clock size={28}/>}
                                                    </div>
                                                    <span className="font-bold text-sm">{isAlreadyCheckedIn ? '·ûÖ·û∂·ûÄ·ûÖ·üÅ·ûâ' : '·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûò·üâ·üÑ·ûÑ'}</span>
                                                </button>

                                                <button 
                                                    onClick={() => setIsPermissionMode(true)}
                                                    className="flex flex-col items-center gap-3 p-5 rounded-3xl bg-white border-2 border-orange-100 text-orange-500 transition-transform active:scale-95 shadow-sm"
                                                >
                                                    <div className="p-3 rounded-full bg-orange-50"><Icons.FileText size={28}/></div>
                                                    <span className="font-bold text-sm">·ûü·ûª·üÜ·ûÖ·üí·ûî·û∂·ûî·üã</span>
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-4 animate-enter">
                                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                                    <label className="text-xs font-bold text-slate-400 uppercase block mb-2">·ûò·ûº·ûõ·û†·üÅ·ûè·ûª ({isAlreadyCheckedIn ? '·ûÖ·üÅ·ûâ' : '·ûÖ·ûº·ûõ'})</label>
                                                    <textarea 
                                                        className="w-full bg-transparent border-none text-slate-700 min-h-[100px] focus:ring-0 p-0 text-sm font-medium placeholder-slate-300"
                                                        placeholder="·ûü·ûö·ûü·üÅ·ûö·ûì·üÖ·ûë·û∏·ûì·üÅ·üá..."
                                                        value={permissionReason}
                                                        onChange={e => setPermissionReason(e.target.value)}
                                                        autoFocus
                                                    ></textarea>
                                                </div>
                                                <div className="flex gap-3">
                                                    <button onClick={() => setIsPermissionMode(false)} className="flex-1 py-3.5 rounded-xl font-bold text-slate-500 bg-slate-100 text-sm">·ûè·üí·ûö·û°·ûî·üã·ûÄ·üí·ûö·üÑ·ûô</button>
                                                    <button onClick={handlePermission} className="flex-1 py-3.5 rounded-xl font-bold text-white gradient-bg shadow-lg shadow-indigo-200 text-sm">·ûî·ûâ·üí·ûá·ûº·ûì</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Delete Confirm */}
                            {deleteTarget && (
                                <div className="bg-white w-full max-w-[300px] rounded-[32px] p-6 text-center relative z-10 animate-enter shadow-2xl">
                                    <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm">
                                        <Icons.Trash />
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800 mb-2">·ûõ·ûª·ûî·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô?</h3>
                                    <p className="text-slate-500 text-xs mb-6 bg-slate-50 py-2 px-4 rounded-xl leading-relaxed">
                                        ·ûè·ûæ·û¢·üí·ûì·ûÄ·ûÖ·ûÑ·üã·ûõ·ûª·ûî·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûö·ûî·ûü·üã<br/>
                                        <b className="text-slate-800 text-sm">"{deleteTarget.name}"</b> ·ûò·üÇ·ûì·ûë·üÅ?
                                    </p>
                                    <div className="flex gap-3">
                                        <button onClick={closeAllModals} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-500 text-sm">·ûë·üÅ</button>
                                        <button 
                                            onClick={deleteRecord} 
                                            className="flex-1 py-3 rounded-xl font-bold text-white bg-slate-800 shadow-lg shadow-slate-300 text-sm"
                                        >
                                            ·ûõ·ûª·ûî
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
